#!/bin/sh

#disable things from grsec for building that we normally want enabled
sysctl -w kernel.grsecurity.chroot_deny_mknod=0
sysctl -w kernel.grsecurity.chroot_caps=0

#./snap.sh || exit
#catalyst -f stage1.spec || exit
#./make_modules.sh || exit
#catalyst -f stage2.spec || exit
#catalyst -f stage3.spec || exit
#catalyst -f stage4.spec || exit

#catalyst -f livecd-stage1.spec
catalyst -f livecd-stage2.spec || exit

mkdir /catalyst/release/Pentoo_x86_64
chmod 777 /catalyst/release/Pentoo_x86_64
su zero -c "gpg --sign --clearsign --yes --digest-algo SHA512 --default-key DD11F94A --homedir /home/zero/.gnupg `awk '/livecd\/iso:/ {print $2}' livecd-stage2.spec`.DIGESTS"

volid="$(grep ^livecd/volid livecd-stage2.spec | cut -d' ' -f2-)"
mktorrent -a http://tracker.cryptohaze.com/announce -n "${volid}" -o /catalyst/release/"${volid}".torrent /catalyst/release/Pentoo_x86_64
